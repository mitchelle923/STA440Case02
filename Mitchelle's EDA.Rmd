---
title: "Mitchelle's EDA"
output: pdf_document
date: "2023-11-01"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(readr)
library(dplyr)
library(ggplot2)
```


#Data
```{r data}
data_2017_2021 <- read_csv("Cleaned Data/data_2017_2021.csv")
data_2022_2023 <- read_csv("Cleaned Data/data_2022_2023.csv") %>% 
  drop_na(Score, E_Score, D_Score, Apparatus, Round, Location, Competition, Country, Gender)

```

```{r}
#remove gymnasts that did not have Scores??
data_2017_2021 %>% 
  filter(is.na(Score)) %>% 
  dplyr::summarise(ct = n())

data_2022_2023 %>% 
  filter(is.na(Score)) %>% 
  dplyr::summarise(ct = n())
```

```{r}
#Competitions types
data_2017_2021 %>% 
  group_by(Competition) %>% 
  dplyr::summarise(ct = n())

data_2022_2023 %>% 
  group_by(Competition) %>% 
  dplyr::summarise(ct = n())
```

```{r}
data_2017_2021 %>% 
  group_by(Round) %>% 
  dplyr::summarise(ct = n())

data_2022_2023 %>% 
  group_by(Round) %>% 
  dplyr::summarise(ct = n())
```
#HERE
```{r}
data_2022_2023 %>% 
  group_by(Competition,Round,Apparatus, Rank) %>% 
  dplyr::summarise(ct = n())
```


```{r}
data_2017_2021 %>% 
  group_by(Apparatus) %>% 
  dplyr::summarise(ct = n())

data_2022_2023 %>% 
  group_by(Apparatus) %>% 
  dplyr::summarise(ct = n())
```


```{r}
# fix first name issue (some have middle names)
```


```{r}
#women 2017-2021 data 
women2017_2021 <- data_2017_2021[data_2017_2021$Gender == "w", ]
#there is no men data in 2017-2021 data table

#women 2022-2023 data
women2022_2023 <- data_2022_2023[data_2022_2023$Gender == "w", ]
#men 2022-2023 data
men2022_2023 <- data_2022_2023[data_2022_2023$Gender == "m", ]

#women USA data 2017-2021
womenUSA2017_2021 <- data_2017_2021[data_2017_2021$Gender == "w"& data_2017_2021$Country == "USA",]


#USA men 2022-2023 data
menUSA2022_2023 <- data_2022_2023[data_2022_2023$Gender == "m"& data_2022_2023$Country == "USA",]
#USA women 2022-2023 data
womenUSA2022_2023 <- data_2022_2023[data_2022_2023$Gender == "w"& data_2022_2023$Country == "USA",]

```

```{r}
 ggplot(data = womenUSA2017_2021, aes(x = Apparatus, y = Score)) +
  geom_boxplot() +
  labs(title = "USA Scores by Apparatus", x = "Appartus", y = "Total Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + facet_wrap(~Round)

 ggplot(data = menUSA2022_2023, aes(x = Apparatus, y = Score)) +
  geom_boxplot() +
  labs(title = "USA Scores by Apparatus", x = "Appartus", y = "Total Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + facet_wrap(~Round)

 ggplot(data = womenUSA2022_2023, aes(x = Apparatus, y = Score)) +
  geom_boxplot() +
  labs(title = "USA Scores by Apparatus", x = "Appartus", y = "Total Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + facet_wrap(~Round)
```

```{r}
 ggplot(data = women2017_2021, aes(x = Apparatus, y = Score)) +
  geom_point() +
  labs(title = "Scores by Apparatus for Women (2017-2021)", x = "Appartus", y = "Total Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

 ggplot(data = women2022_2023, aes(x = Apparatus, y = Score)) +
  geom_point() +
  labs(title = "Scores by Apparatus for Women(2022-2023)", x = "Appartus", y = "Total Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
 
  ggplot(data = men2022_2023, aes(x = Apparatus, y = Score)) +
  geom_point() +
  labs(title = "Scores by Apparatus for Men (2022-2023)", x = "Appartus", y = "Total Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
 
```
```{r}
data_2022_2023 %>% 
  group_by(Competition, Round, Rank) %>% 
  dplyr::summarise(ct = n())
```

So far we subsetted the top 20% percentile by Gender and Apparatus
```{r}
#take out middle names because some names have first name and some have middle (Frederick (Nathaniel) Richard)
data_2022_2023$FirstNameOnly <- sub("^(\\w+)\\s+\\w+$", "\\1", data_2022_2023$FirstName)
```


```{r}
#subsetting 2nd data set by individual athlete
data_2022_2023 %>% 
  group_by(Gender,Competition,Round,Apparatus, Rank) %>% 
  dplyr::summarise(ct = n())

data_2022_2023 %>% 
  group_by(Gender, Apparatus) %>% 
  mutate(meanScore = mean(Score))
```
```{r}
data_2022_2023 %>% 
  group_by(Gender,Apparatus) %>% 
  mutate()
  summarise(meanScore =  mean(Score))
```


```{r}
data_2022_2023 %>% 
  filter(Country == 'USA') %>% 
  group_by(LastName,FirstName) %>% 
  dplyr::summarise(sum = n())
```
# Final Submission Work

```{r}
laterdata <- read_csv("Cleaned Data/data_2022_2023.csv")
later <- laterdata |>
  drop_na(Score, E_Score, D_Score, Apparatus, Round, Location, Competition, Country, Gender)
```

```{r}
#indonesian gymnast's name is Abiyu RAFI not ABIYURAFI
laterdata <- laterdata |>
  mutate(FirstName = ifelse(LastName == "ABIYURAFI" & FirstName == ".", "Abiyu", FirstName),
    LastName = ifelse(LastName == "ABIYURAFI", "RAFI", LastName))


laterdata <- laterdata |>
  mutate(firstname_check = ifelse(str_length(FirstName) >= 3, 1, 0),
         lastname_check = ifelse(str_length(LastName) >= 3, 1, 0))

laterdata <- laterdata |>
  mutate(FirstName = ifelse(firstname_check == 0, paste0(FirstName, "_"), FirstName),
         LastName = ifelse(lastname_check == 0, paste0(LastName, "_"), LastName))

#based on string methods -- creating unique athlete IDs
laterdata <- laterdata |>
  mutate(unique_id = paste0(str_sub(FirstName, 1, 3), str_sub(LastName, 1, 3), "_", Country))

#create a vector for AA or team
AA_team <- c("AAfinal", "TeamFinal", "TeamQual", "AAqual")
'%notin%' <- function(x,y)!('%in%'(x,y))

finals_vector <- c("AAfinal", "TeamFinal", "final")

#these quantiles are already grouped by gender and competition, round, apapratus, etc. so no bleeding
quantiled_data <- laterdata |>
  group_by(Gender, Competition, Round, Apparatus) |>
  mutate(quantile_20s = ntile(-Score, 5),
         quantile_10s = ntile(-Score, 10))

#filter out the athletes who have NEVER made it to a final, ever
filtered_data <- quantiled_data |>
  group_by(unique_id) |>
  filter(any(Round == "final" | Round == "TeamFinal" | Round == "AAfinal")) |>
  ungroup()

#summary of number of athletes competed in each competition in each round
number_athletes <- filtered_data |>
  group_by(Competition, Round) |>
  summarise(athletes_participated = n_distinct(unique_id))


# at the oceania continental championships, only 10 unique athletes competed
# every other competition at each round has at minimum 36 athletes competing
#at these final rounds, there are at least 40 athletes in each final, so it's fine
#going to left join to show the number of athletes that participated per round

joined_data <- filtered_data |>
  left_join(number_athletes, by = c("Competition", "Round"))

#now the athletes_participated column = how many athletes competed in it


#this filters out the individual records for ppl who were not in top quantiles at a competition
final_data <- joined_data |>
  filter((athletes_participated <= 100 & quantile_20s == 1) | (athletes_participated > 100 & quantile_10s == 1) | (Competition == "Oceania Continental Championships 2023" & quantile_20s %in% c(1, 2)))

#now let's check the number of unique athletes left
# final_data |>
#   group_by(Country) |>
#   summarise(athletes_left = n_distinct(unique_id))

#there are 679 athletes left in total once we have filtered, USA still has 91 left
```

```{r}
menOG <- data_2022_2023 %>% 
  filter(Gender == 'm') %>% 
  mutate(USA = ifelse(Country == 'USA', TRUE, FALSE))
  
womenOG <- data_2022_2023 %>% 
  filter(Gender == 'w') %>% 
  mutate(USA = ifelse(Country == 'USA', TRUE, FALSE))
```

```{r}
ggplot(data = menOG, aes(x = Score, group = USA, fill = USA)) + geom_density(adjust = 1.5) + facet_wrap(~Round) + labs(title = "Men's Score Density by Event Type", subtitle = "USA vs Non-USA")

ggplot(data = womenOG, aes(x = Score, group = USA, fill = USA)) + geom_density(adjust = 1.5) + facet_wrap(~Round) + labs(title = "Women's Score Density by Event Type", subtitle = "USA vs Non-USA")
```
## Original Data
The USA men's teams tend to have a greater concentration in higher scores than
non USA competitors in individual qualifiers as well team qualifiers and finals.
This shows that for the men's team our model should prioritize the team all 
around events.

The USA women's teams tend to have a greater concentration in higher scores than
non USA competitors in all rounds, but especially more so in team all around.
Individual apparatuses are also a great focus since that would maximize the actual
medal count and team USA tends to have higher scores than non USA competitors.


## Finalized Data
```{r}
menFinal <- final_data %>% 
  filter(Gender == 'm')

womenFinal <- final_data %>% 
  filter(Gender == 'w')
```

```{r}
#make a USA and nonUSA factored column
menFinal <- menFinal %>% 
  mutate(USA = ifelse(Country == 'USA', TRUE, FALSE))
womenFinal <- womenFinal %>% 
  mutate(USA = ifelse(Country == 'USA', TRUE, FALSE))
```

```{r}
ggplot(data = menFinal, aes(x = Score, group = USA, fill = USA)) + geom_density(adjust = 1.5) + facet_wrap(~Round) + labs(title = "Men's Score Density by Event Type (Finalized Data)", subtitle = "USA vs Non-USA")

ggplot(data = womenFinal, aes(x = Score, group = USA, fill = USA)) + geom_density(adjust = 1.5) + facet_wrap(~Round) + labs(title = "Women's Score Density by Event Type (Finalized Data)", subtitle = "USA vs Non-USA")
```
For the men's densities we can see that the USA athletes have more concentration on
higher scores than non USA teams for the individual qualifying and team qualifying round.

For the women's denities there is more concentration on higher scores for the USA
team for both individual apparatus rounds (final and qualifying) as well as
the team qualifiers. Which futher proves our model should focus on a mixture of both
but heavily prioritize the individual appartuses.

# NEW RANKING
## Men
```{r}
#rank actually shown to be correct here for the early observations
orderMenFinal <- menFinal %>% 
  arrange(Competition, Round, Apparatus, desc(Score)) %>% 
  dplyr::select(unique_id, Country,Competition, Round,Apparatus, Rank, Score)
orderMenFinal
```
### Men's Individual Apparatus Ranking System
```{r}
#this ranking works for individual apparatus but not team all-around and individual all around since it takes total scoring for ranking
#also important to note that rankers did not give same scores the same rank, but this will be done in new rank
orderMenFinal_individual <- orderMenFinal %>%
  mutate(newRank = NA) %>% 
  filter(Round == 'qual' | Round == 'final')
orderMenFinal_individual$newRank[1] <- 1

for (i in 2:nrow(orderMenFinal_individual)){
  if ((orderMenFinal_individual$Competition[i] == orderMenFinal_individual$Competition[i-1]) & (orderMenFinal_individual$Round[i] == orderMenFinal_individual$Round[i-1]) & (orderMenFinal_individual$Apparatus[i] == orderMenFinal_individual$Apparatus[i-1]) & (orderMenFinal_individual$Score[i] == orderMenFinal_individual$Score[i-1])) {
    orderMenFinal_individual$newRank[i] <- orderMenFinal_individual$newRank[i-1]
  } 
  else if ((orderMenFinal_individual$Competition[i] == orderMenFinal_individual$Competition[i-1]) & (orderMenFinal_individual$Round[i] == orderMenFinal_individual$Round[i-1]) & (orderMenFinal_individual$Apparatus[i] == orderMenFinal_individual$Apparatus[i-1])) {
    orderMenFinal_individual$newRank[i] <- orderMenFinal_individual$newRank[i-1]+1
  }
  else {
    orderMenFinal_individual$newRank[i] <- 1
  }
}
orderMenFinal_individual
```
### Men's 
```{r}
menFinal %>% 
  filter(Round == 'AAfinal' | Round == 'AAqual') %>% 
  arrange(Competition, Round, Country, Apparatus, desc(Score)) %>% 
  dplyr::select(unique_id, Country,Competition, Round,Apparatus, Rank, Score)
```


#Women
```{r}
#rank actually shown to be correct here for the early observations
orderWomenFinal <- womenFinal %>% 
  arrange(Competition, Round, Apparatus, desc(Score)) %>% 
  dplyr::select(unique_id, Country,Competition, Round,Apparatus, Rank, Score)
orderWomenFinal
```
```{r}
orderWomenFinal <- orderWomenFinal %>%
  mutate(newRank = NA)
orderWomenFinal$newRank[1] <- 1

for (i in 2:nrow(orderWomenFinal)){
  if ((orderWomenFinal$Competition[i] == orderWomenFinal$Competition[i-1]) & (orderWomenFinal$Round[i] == orderWomenFinal$Round[i-1]) & (orderWomenFinal$Apparatus[i] == orderWomenFinal$Apparatus[i-1])) {
    orderWomenFinal$newRank[i] <- orderWomenFinal$newRank[i-1]+1
  } else {
    orderWomenFinal$newRank[i] <- 1
  }
}
orderWomenFinal
```

